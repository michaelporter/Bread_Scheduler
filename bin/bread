#!/usr/bin/env ruby

$: << File.join(File.dirname(__FILE__), "/..")

require 'config/gems'
require 'lib/bread.rb'
require 'lib/database_setup.rb'
require 'lib/scheduler/scheduler.rb'

class BreadScheduler < Thor
  desc 'new --name \'My Bread!\' --rise 120 --bake 30 --loaves 2', 'create a new bread'
  option :name; option :rise; option :bake; option :loaves
  def new
    puts "you created a bread with the following details:"

    @bread = Bread.new(options)
    @bread.describe_bread
    @bread.save
  end

  desc 'schedule --all | --breads "My Bread!" "White Bread" | --breads 1 2 3', 'create new schedule with given breads'
  option :all; option :breads, :type => :array
  def schedule
    if options[:all]
      items = Bread.all
      puts items.inspect
    elsif options[:breads]
      names = options[:breads].dup
      ids = options[:breads].dup

      names.keep_if {|name| /\A\D+\z/ =~ name }
      ids.keep_if {|id| /\A\d+\z/ =~ id }

      result_names = Bread.find(:column => 'name', :values => names)
      result_ids = Bread.find(:column => 'id', :values => ids)

      items = (result_names + result_ids).uniq
    end

    puts items.inspect

    scheduler = Scheduler.new(
      :items => items
    )

    scheduler.schedule!
  end
end

BreadScheduler.start(ARGV)
